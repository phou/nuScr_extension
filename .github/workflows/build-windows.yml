name: Cross-build nuscr (Linux -> Windows)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-cross-win:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      OCAML_VERSION: "5.1.1"           # adjust if your project uses a different OCaml
      OPAMROOT: "${{ runner.temp }}/.opam"  # isolated opam root per job

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        # installs mingw-w64 toolchain, pkg-config, protobuf (for protoc), unzip, curl, build-essential
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential curl ca-certificates git pkg-config \
            mingw-w64 mingw-w64-tools mingw-w64-x86-64-dev \
            autoconf automake libtool unzip python3
          # install protoc (Linux host) - adjust version if needed
          sudo apt-get install -y protobuf-compiler

      - name: Install OPAM
        run: |
          sudo apt-get install -y opam
          opam --version

      - name: Init OPAM and create switch
        shell: bash
        run: |
          opam init --disable-sandboxing --auto-setup -y
          opam switch create "$OCAML_VERSION" --no-install -y || opam switch set "$OCAML_VERSION"
          eval $(opam env)
          opam repo update

      - name: Install opam deps for cross-build
        shell: bash
        run: |
          eval $(opam env)
          # install dune and common build tools first
          opam install -y dune menhir conf-pkg-config pkg-config ocamlbuild ocamlfind
          # ensure conf-protoc and other system prerequisites are available
          opam install -y conf-protoc || true
          # install project dependencies (attempt) - this will install ocaml dependencies only
          opam pin add nuscr . -n || true
          opam install --deps-only -y .

      - name: Configure cross-toolchain environment
        shell: bash
        run: |
          # Tell the build system to use mingw-w64 cross compilers when compiling C stubs
          export CROSS_PREFIX=x86_64-w64-mingw32
          echo "Using CROSS_PREFIX=$CROSS_PREFIX"
          # Set common env vars that dune will pick up for C compilation/linking steps
          echo "export CC=${CROSS_PREFIX}-gcc" >> $GITHUB_ENV
          echo "export CXX=${CROSS_PREFIX}-g++" >> $GITHUB_ENV
          echo "export AR=${CROSS_PREFIX}-ar" >> $GITHUB_ENV
          echo "export RANLIB=${CROSS_PREFIX}-ranlib" >> $GITHUB_ENV
          echo "export STRIP=${CROSS_PREFIX}-strip" >> $GITHUB_ENV
          # PKG_CONFIG_PATH may be used if libraries are installed under mingw; leave empty unless you install libs under /usr/${CROSS_PREFIX}
          echo "export PKG_CONFIG_PATH=" >> $GITHUB_ENV

      - name: Build (Linux native binary, to confirm host build works)
        shell: bash
        run: |
          eval $(opam env)
          dune build @install || dune build

      - name: Attempt cross-build for Windows
        shell: bash
        run: |
          set -e
          eval $(opam env)
          echo "Environment: $(uname -a)"
          # Try to instruct dune/ocaml to produce a Windows-targeted binary.
          # NOTE: OCaml's native code generator is not trivially cross-compilable.
          # We attempt to compile with ocamlopt but with MinGW's linker via CC/CXX env vars for C stubs.
          export CC=x86_64-w64-mingw32-gcc
          export CXX=x86_64-w64-mingw32-g++
          export AR=x86_64-w64-mingw32-ar
          export RANLIB=x86_64-w64-mingw32-ranlib
          export STRIP=x86_64-w64-mingw32-strip
          # Some projects accept a DESTDIR or PREFIX; we try a straightforward dune build output path
          # Try building the executable that would be produced for the target:
          dune build --profile release @install || dune build --profile release
          # If dune produced a .exe in _build, find it and copy to artifact path:
          find _build -type f -iname "*.exe" -print || true
          # Attempt to move an exe to artifact/output (many projects will not produce .exe this way)
          if [ -f _build/default/bin/nuscr.exe ]; then
            mkdir -p out
            cp _build/default/bin/nuscr.exe out/nuscr.exe
          else
            echo "No _build/default/bin/nuscr.exe found â€” attempting to convert or link"
            # Try find any executables that might be PE files (heuristic)
            EXE=$(find _build -type f -print0 | xargs -0 file 2>/dev/null | grep -i 'PE32' | cut -d: -f1 || true)
            if [ -n "$EXE" ]; then
              mkdir -p out
              cp "$EXE" out/nuscr.exe
            else
              echo "No Windows exe detected in build output."
            fi
          fi
          ls -la out || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuscr-artifacts
          path: |
            _build/default/bin/*
            out/*.exe
            _build/default/*

