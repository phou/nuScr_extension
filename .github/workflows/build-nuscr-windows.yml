name: Package nuscr (Windows)

on:
  push:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1. Checkout packaging repo
      - uses: actions/checkout@v4

      # 2. Checkout nuscr
      - name: Checkout nuscr
        uses: actions/checkout@v4
        with:
          repository: nuscr/nuscr
          ref: develop
          path: nuscr

      # 3. Set up OCaml + opam
      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5.1.1

      # 4. Build nuscr
      - name: Build nuscr
        shell: pwsh
        working-directory: nuscr
        run: |
          # Create and activate switch
          opam switch create nuscr-switch ocaml.5.1.1
          (& opam env) -split '\r?\n' | ForEach-Object { Invoke-Expression $_ }

          # Pin ALL local packages (CRITICAL)
          opam pin add . --recursive -y

          # Install dependencies
          opam install . --deps-only -y

          # Install dune and refresh PATH
          opam install dune -y
          (& opam env) -split '\r?\n' | ForEach-Object { Invoke-Expression $_ }

          # Build
          dune build

      # 5. Package binary
      - name: Package Windows binary
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path package
          Copy-Item nuscr\_build\default\bin\nuscr.exe package\

      # 6. Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuscr-windows
          path: package/nuscr.exe
