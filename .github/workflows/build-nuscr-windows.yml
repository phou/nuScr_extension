name: Build nuscr Windows binary

on:
  push:
  workflow_dispatch:

jobs:
  build-nuscr-win:
    runs-on: windows-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      # Checkout the nuscr repo into ./nuscr
      - name: Checkout nuscr
        uses: actions/checkout@v4
        with:
          repository: nuscr/nuscr
          ref: develop          # or a tag like "2.1.1" if you prefer
          path: nuscr

      - name: Set up OCaml + opam
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: '5.3.0'

      # Install protoc so conf-protoc can succeed
      - name: Install protoc (Protocol Buffers compiler)
        shell: pwsh
        run: |
          choco install protoc -y

      - name: Build nuscr and copy Windows binary
        shell: pwsh
        working-directory: nuscr
        run: |
          # Activate opam env for this shell
          (& opam env) -split '\r?\n' | ForEach-Object { Invoke-Expression $_ }

          # IMPORTANT: make Cygwin's pkg-config visible (installed by conf-pkg-config)
          $env:PATH = "C:\cygwin\bin;$env:PATH"

          # Pin only the 'nuscr' package to this checkout
          opam pin add nuscr . --with-version=dev -y

          # Install nuscr (installs deps + runs dune build -p nuscr @install)
          opam install nuscr -y

          # Refresh env so installed bin dir is in PATH
          (& opam env) -split '\r?\n' | ForEach-Object { Invoke-Expression $_ }

          # Copy resulting Windows binary out of the switch
          Copy-Item "$env:OPAM_SWITCH_PREFIX\bin\nuscr.exe" `
                    "$env:GITHUB_WORKSPACE\nuscr-windows.exe"

      - name: Upload nuscr.exe as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuscr-windows
          path: nuscr-windows.exe
