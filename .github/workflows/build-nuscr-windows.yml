name: Package nuscr (Windows)

on:
  push:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1. Checkout the packaging repo (this repo)
      - name: Checkout packaging repo
        uses: actions/checkout@v4

      # 2. Checkout nuscr into a subdirectory
      - name: Checkout nuscr
        uses: actions/checkout@v4
        with:
          repository: nuscr/nuscr
          path: nuscr
          # optionally pin a version:
          # ref: v0.3.2

      # 3. Set up OCaml + opam
      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5.1.1

      # 4. Build nuscr
      - name: Build nuscr
        working-directory: nuscr
        shell: pwsh
        run: |
          # Make sure opam env is active
          opam env --switch=default --set-switch | Invoke-Expression

          # Pin the local repo so internal packages resolve
          opam pin add nuscr . -y --no-action

          # Install dependencies
          opam install . --deps-only -y

          # Ensure dune is available
          opam install dune -y

          # Build
          dune build

      # 5. Package the Windows binary
      - name: Package binary
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path package
          Copy-Item nuscr\_build\default\bin\nuscr.exe package\

      # 6. Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuscr-windows
          path: package/nuscr.exe
